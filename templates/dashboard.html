<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Sipari≈üler | √áoklu Maƒüaza</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#f5f7fb; padding:15px; }

    .products-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
      gap:10px;
    }
    .line-card {
      background:#fff;
      border:1px solid #ddd;
      border-radius:10px;
      padding:8px;
    }
    .product-img {
      width:100%;
      height:120px;
      border-radius:8px;
      object-fit:cover;
      cursor:pointer;
      background:#eee;
    }

    .pagination-container {
      display:flex;
      justify-content:center;
      margin-top:20px;
    }

    .pagination a {
      padding:8px 14px;
      margin:0 4px;
      background:#fff;
      border:1px solid #ddd;
      border-radius:6px;
      text-decoration:none;
      color:#333;
      font-weight:600;
    }

    .pagination a.active {
      background:#0d6efd;
      color:#fff;
      border-color:#0d6efd;
    }

    .pagination a:hover {
      background:#e9ecef;
    }
  </style>
</head>

<body>

<!-- ===== √úST BAR ===== -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex align-items-center gap-2">
    <img src="{{ url_for('static', filename='logo.png') }}" style="height:34px;">
    <h3 class="mb-0">YAKAMEL</h3>
  </div>

  <input id="searchBox" type="search" class="form-control" placeholder="Ara‚Ä¶" style="max-width:220px;">

  <a href="{{ url_for('index') }}" class="btn btn-secondary">‚¨Ö Ana Sayfa</a>
</div>

<style>
.btn-warning {
  background: linear-gradient(45deg,#ff8c00,#ffb347);
  color:white;
  border:none;
}
.btn-warning:hover {
  background: linear-gradient(45deg,#ffa333,#ffd066);
}
</style>

<!-- ===== Fƒ∞LTRELER ===== -->
<form id="filterForm" class="d-flex flex-wrap gap-3 mb-3" method="get" action="{{ url_for('dashboard') }}">

  <!-- üî• 24 Saat Kalanlar BUTONU -->
  <a href="{{ url_for('dashboard', urgent='true') }}"
     class="btn btn-warning"
     style="height:38px; display:flex; align-items:center;">
    ‚è∞ 24 Saatten Az Kalan Sipari≈üler
    <span class="badge bg-dark ms-2">{{ urgent_count }}</span>
  </a>

  <!-- Maƒüaza -->
  <select name="supplier" class="form-select" style="max-width:150px;">
    <option value="">T√ºm√º</option>
    <option value="564724" {% if request.args.get('supplier') == '564724' %}selected{% endif %}>RUNADES</option>
    <option value="940685" {% if request.args.get('supplier') == '940685' %}selected{% endif %}>YAKAMEL TEKSTƒ∞L</option>
    <option value="938355" {% if request.args.get('supplier') == '938355' %}selected{% endif %}>YKML</option>
    <option value="1086036" {% if request.args.get('supplier') == '1086036' %}selected{% endif %}>CMZ COLLECTION</option>
    <option value="1127426" {% if request.args.get('supplier') == '1127426' %}selected{% endif %}>BARLƒ∞Z TEKSTƒ∞L</option>
    <option value="994330" {% if request.args.get('supplier') == '994330' %}selected{% endif %}>BAY BAYAN</option>
  </select>

  <!-- Renk -->
  <select name="color" class="form-select" style="max-width:140px;">
    <option value="">T√ºm√º</option>
    {% for renk in ["Sƒ∞YAH","LACƒ∞VERT","F√úME","KAHVERENGƒ∞","HAKƒ∞","BEYAZ","BEJ","GRƒ∞","KIRMIZI","MAVƒ∞","YE≈ûƒ∞L"] %}
      <option value="{{ renk }}" {% if request.args.get('color') == renk %}selected{% endif %}>{{ renk }}</option>
    {% endfor %}
  </select>

  <!-- Stat√º -->
  <select name="status" class="form-select" style="max-width:160px;">
    {% for s in ['Created','Picking','Shipped','Delivered'] %}
      <option value="{{ s }}" {% if request.args.get('status','Created') == s %}selected{% endif %}>{{ s }}</option>
    {% endfor %}
  </select>

  <!-- üî• STOK KODU Fƒ∞LTRESƒ∞ -->
<div class="dropdown">
  <button class="btn btn-light dropdown-toggle fw-bold" type="button" data-bs-toggle="dropdown">
      Stok Kodu
  </button>

  <ul class="dropdown-menu p-2" style="max-height:300px; overflow-y:auto;">

      <!-- Hepsi -->
      <li>
        <a class="dropdown-item {% if 'ALL' in selected_filters %}active fw-bold{% endif %}"
           href="{{ url_for('dashboard',
                            supplier=request.args.get('supplier'),
                            color=request.args.get('color'),
                            status=request.args.get('status','Created'),
                            filter='ALL') }}">
            Hepsi
        </a>
      </li>

      <!-- Kodlar -->
      {% for code in [
        "HRKA","BMBRTK","ETK3I","KFTK","FDKY","BSKLE","KIKT","CNT","MTR","ETKP",
        "TAYT","ESF3I","ESPE","SWT3I","PLZO","KSKP","ESFKP","KMTK",
        "BKTK","KKTK","OFBS","BTSH","SBP","SGP","UBP","UGP",
        "KBP","KGP","ULP","KKFE","BSKLTY","TSH","FSAH",
        "KSTK","OFTA","HRTK","EPA","OBSWT","DYTK","SLP","KLP",
        "ELBS","DKP","KMNO","ESTK","SAL","BAT","HRKI","PBK",
        "OFT","PLR","SFTK","KUKT"
      ] %}
      <li>
        <a class="dropdown-item {% if code in selected_filters %}active fw-bold{% endif %}"
           href="{{ url_for('dashboard',
                            supplier=request.args.get('supplier'),
                            color=request.args.get('color'),
                            status=request.args.get('status','Created'),
                            filter=code) }}">
            {{ code }}
        </a>
      </li>
      {% endfor %}
  </ul>
</div>

<!-- üì¶ Kargo Excel Raporu (Buraya EKLENDƒ∞) -->
<a href="/kargo-raporu" class="btn btn-success"
   style="height:38px; display:flex; align-items:center;">
  üì¶ Kargo Excel Raporu
</a>
  <button class="btn btn-primary">Filtrele</button>
</form>


<!-- ===== TABLO ===== -->
<div class="table-responsive bg-white rounded shadow-sm">
  <table class="table table-hover align-middle mb-0">
    <thead class="table-dark">
  <tr>
    <th>#</th>
    <th>Maƒüaza</th>
    <th>Sipari≈ü</th>
    <th>Tarih</th>
    <th>√úr√ºnler (max 100)</th>
    <th>Durum</th>
    <th>ƒ∞≈ülem</th>
    <th>Yazdƒ±r</th>
  </tr>
</thead>

    <tbody id="ordersBody">

      {% for o in orders %}
<tr>
    <td>{{ (page-1) * per_page + loop.index }}</td>

        <td><span class="badge bg-info text-dark">{{ o.supplier_name }}</span></td>

        <td>
          <b>{{ o.orderNumber }}</b><br>
          <small>{{ o.customerFirstName }} {{ o.customerLastName }}</small>
        </td>

        <td>
    {{ o.orderDateFormatted }}

    {% set deadline = o.extendedAgreedDeliveryDate or o.agreedDeliveryDate %}
    <div class="small text-danger countdown"
         data-deadline="{{ deadline }}">
         Kalan: ‚Äî
    </div>
</td>


        <td>
  <div class="products-grid">
    {% for l in o.lines %}
    <div class="line-card">

      <!-- üî• SKU fallback -->
      <img class="product-img lazy-img"
           data-supplier="{{ o.supplier_id }}"
           data-barcode="{{ l.barcode }}"
           data-merchant-sku="{{ l.merchantSku }}"
           data-sku="{{ l.sku }}"
           data-product-code="{{ l.productCode }}">

      <div class="fw-bold" style="font-size:.9rem">{{ l.productName }}</div>

      <div class="text-muted" style="font-size:.8rem">Renk: {{ l.productColor }}</div>

      <!-- üî• YENƒ∞ EKLENDƒ∞: STOK KODU -->
      <div class="text-muted" style="font-size:.8rem">
        Stok Kodu: {{ l.merchantSku or l.sku or "-" }}
      </div>

      <div class="text-muted" style="font-size:.8rem">Beden: {{ l.productSize }}</div>

      {% if l.quantity > 1 %}
        <span class="badge bg-danger text-white" style="font-size:1rem;">Adet: {{ l.quantity }}</span>
      {% else %}
        <span class="badge bg-warning text-dark">Adet: 1</span>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</td>


        <td>{{ o.status }}</td>
<td>
 <form method="POST" action="{{ url_for('isleme_al', supplier_id=o.supplier_id, package_id=o.id) }}">
    <input type="hidden" name="lines" value='{{ o.lines | tojson }}'>

    <input type="hidden" name="status" value="{{ request.args.get('status', 'Created') }}">
    <input type="hidden" name="page" value="{{ page }}">
    <input type="hidden" name="supplier" value="{{ request.args.get('supplier','') }}">
    <input type="hidden" name="color" value="{{ request.args.get('color','') }}">

    {% for f in request.args.getlist('filter') %}
      <input type="hidden" name="filter" value="{{ f }}">
    {% endfor %}

    <input type="hidden" name="urgent" value="{{ request.args.get('urgent','') }}">

    <!-- üî• Satƒ±r index -->
    <input type="hidden" name="row_index" value="{{ loop.index }}">

    <button class="btn btn-primary btn-sm">ƒ∞≈üleme Al</button>
</form>

</td>


        <td>
          <button class="btn btn-secondary btn-sm btn-print"
                  data-url="{{ url_for('etiket_yazdir', supplier_id=o.supplier_id, package_id=o.id) }}">
            üñ®
          </button>
        </td>
      </tr>
      {% endfor %}

    </tbody>
  </table>
</div>

<!-- ========================= -->
<!--     PAGINATION           -->
<!-- ========================= -->
<div class="pagination-container">
  <div class="pagination">

    {% if page > 1 %}
      <a href="{{ url_for('dashboard', page=1, **current_filters) }}">¬´ ƒ∞lk</a>
      <a href="{{ url_for('dashboard', page=page-1, **current_filters) }}">‚Äπ √ñnceki</a>
    {% endif %}

    {% for p in page_numbers %}
      <a href="{{ url_for('dashboard', page=p, **current_filters) }}"
         class="{% if p == page %}active{% endif %}">
        {{ p }}
      </a>
    {% endfor %}

    {% if page < total_pages %}
      <a href="{{ url_for('dashboard', page=page+1, **current_filters) }}">Sonraki ‚Ä∫</a>
      <a href="{{ url_for('dashboard', page=total_pages, **current_filters) }}">Son ¬ª</a>
    {% endif %}

  </div>
</div>

<!-- ========================= -->
<!--     G√ñRSEL POPUP          -->
<!-- ========================= -->
<div class="modal fade" id="imgModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-body d-flex justify-content-center align-items-center">
        <img id="modalImg" src="" style="max-width:95vw; max-height:95vh; border-radius:10px;">
      </div>
    </div>
  </div>
</div>

<!-- ========================= -->
<!--     YAZDIRMA POPUP        -->
<!-- ========================= -->
<div class="modal fade" id="printModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4 text-center">
      <div class="spinner-border"></div>
      <div class="mt-2">Etiket hazƒ±rlanƒ±yor‚Ä¶</div>
      <iframe id="printFrame" style="width:0;height:0;border:0;position:absolute;"></iframe>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ===============================
//   üìå ARAMA
// ===============================
document.getElementById("searchBox").addEventListener("input", function() {
    const q = this.value.toLowerCase().trim();
    document.querySelectorAll("#ordersBody tr").forEach(tr => {
        tr.style.display = tr.innerText.toLowerCase().includes(q) ? "" : "none";
    });
});


// ===============================
//   üìå G√ñRSEL POPUP
// ===============================
const imgModal = new bootstrap.Modal(document.getElementById("imgModal"));
const modalImg = document.getElementById("modalImg");

document.addEventListener("click", e => {
    const img = e.target.closest(".product-img");
    if (!img) return;
    modalImg.src = img.src;
    imgModal.show();
});

modalImg.addEventListener("click", () => imgModal.hide());


// ===============================
//   üìå YAZDIRMA POPUP
// ===============================
document.addEventListener("click", e => {
    const btn = e.target.closest(".btn-print");
    if (!btn) return;

    const modal = new bootstrap.Modal(document.getElementById("printModal"));
    const iframe = document.getElementById("printFrame");

    iframe.onload = () => {
        try { iframe.contentWindow.print(); } catch(err){}
        setTimeout(() => modal.hide(), 1200);
    };

    iframe.src = btn.dataset.url + "?_=" + Date.now();
    modal.show();
});


// ===============================
//   üìå LAZY LOAD
// ===============================
function loadImage(img) {
    const qs = new URLSearchParams({
        supplier_id: img.dataset.supplier,
        barcode: img.dataset.barcode,
        merchantSku: img.dataset.merchantSku,
        sku: img.dataset.sku,
        productCode: img.dataset.productCode
    });

    fetch("/api/line-image?" + qs.toString())
        .then(r => r.json())
        .then(d => {
            if (d.url) img.src = d.url;
        });
}

document.querySelectorAll("img.lazy-img").forEach(loadImage);


// ===============================
//   üìå COUNTDOWN
// ===============================
function fmt(ms){
    const total = Math.floor(ms / 1000);
    const d = Math.floor(total / 86400);
    const h = Math.floor((total % 86400) / 3600);
    const m = Math.floor((total % 3600) / 60);
    const s = total % 60;

    if (d > 0) return `${d} g√ºn ${h} saat ${m} dk`;
    return `${h} saat ${m} dk ${s} sn`;
}

function tickCountdowns(){
    const now = Date.now();
    document.querySelectorAll(".countdown").forEach(el => {
        const dl = Number(el.dataset.deadline);
        if (!dl) {
            el.textContent = "Kalan: ‚Äî";
            return;
        }

        const diff = dl - now;
        if (diff <= 0) {
            el.textContent = "S√úRE DOLDU ‚ùó";
        } else {
            el.textContent = "Kalan: " + fmt(diff);
        }
    });
}

tickCountdowns();
setInterval(tickCountdowns, 1000);


// ======================================
// üî• ƒ∞≈ülem sonrasƒ± aynƒ± sƒ±raya geri d√∂n
// ======================================
document.addEventListener("DOMContentLoaded", function() {
    const rowIndex = new URLSearchParams(window.location.search).get("row_index");
    if (rowIndex) {
        const row = document.querySelector(`#ordersBody tr:nth-child(${rowIndex})`);
        if (row) {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
});

</script>


</body>
</html>
