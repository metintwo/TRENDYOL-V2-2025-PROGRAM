<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Sipari≈üler | √áoklu Maƒüaza</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    html, body { height:100%; }
    body { background:#f5f7fb; padding:12px; }

    .badge{ font-size:.85rem; }
    .table thead th{ white-space:nowrap; }

    /* ===== √úst Bar (sol-orta-saƒü) ===== */
    .toolbar-grid{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      align-items:center;
      column-gap:24px;
      row-gap:10px;
      margin-bottom:18px;
    }
    .toolbar-left{ display:flex; align-items:center; gap:10px; }
    .toolbar-right{ display:flex; justify-content:flex-end; align-items:center; gap:10px; }
    .brand .logo{ height:28px; width:auto; user-select:none; -webkit-user-drag:none; }
    .counter-pill{
      background:#fff7e6; color:#b76e00;
      border:1px solid #f1b04c; border-radius:999px;
      padding:.5rem 1.2rem; font-weight:600; white-space:nowrap;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    .search-input{ min-width:360px; }
    @media (max-width:992px){
      .toolbar-grid{ grid-template-columns:1fr; }
      .search-input{ min-width:0; width:100%; }
      .toolbar-right{ justify-content:stretch; }
    }

    /* ===== √úr√ºn kutularƒ± ===== */
    .products-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:10px; align-items:start; }
    .line-card{ background:#fff; border:1px solid #e7eaf0; border-radius:10px; padding:8px; box-shadow:0 2px 6px rgba(0,0,0,.04); height:100%; display:flex; flex-direction:column; gap:6px; }
    .line-card img.product-img{ width:100%; height:120px; border-radius:8px; object-fit:cover; cursor:zoom-in; background:#eee; }
    .line-name{ font-size:.92rem; font-weight:600; line-height:1.2; min-height:2.2em; }
    .line-meta{ font-size:.85rem; color:#6c757d; line-height:1.2; }
    .qty-badge{ font-weight:600; letter-spacing:.2px; }

    /* ===== G√∂rsel modalƒ± ===== */
    #imgModal .modal-content{ background:transparent!important; border:none; box-shadow:none; }
    #imgModal .modal-body{ background:transparent!important; padding:0; display:flex; align-items:center; justify-content:center; min-height:40vh; }
    #modalImg{ max-width:96vw; max-height:96vh; object-fit:contain; border-radius:10px; box-shadow:0 6px 24px rgba(0,0,0,.2); cursor:zoom-out; }

    /* ===== Yazdƒ±rma modalƒ± ===== */
    #printModal .modal-content{ background:rgba(255,255,255,.9); border-radius:12px; border:0; box-shadow:0 6px 24px rgba(0,0,0,.15); }

    #sentinel{ padding:14px; color:#6c757d; }
  </style>
</head>
<body class="container-fluid py-3">

<!-- ===== √úST BAR ===== -->
<div class="toolbar-grid align-items-center" style="grid-template-columns: auto 1fr auto;">

  <!-- Sol: Logo + YAKAMEL -->
  <div class="toolbar-left d-flex align-items-center gap-2">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo" loading="eager" style="height:34px;">
    <h3 class="mb-0" style="font-size:1.6rem; font-weight:700;">YAKAMEL</h3>

    <!-- K√º√ß√ºlt√ºlm√º≈ü arama -->
    <input id="searchBox" type="search" class="form-control" placeholder="Ara‚Ä¶"
           style="max-width:200px; margin-left:10px;">
  </div>

  <!-- Orta: Kargolanacak toplam -->
  <div class="text-center">
    <span id="todoBadge" class="counter-pill">
      Kargolanacak Toplam Kargo: <strong id="todoCount">{{ total_to_ship }}</strong>
    </span>
  </div>

  <!-- Saƒü: Ana Sayfa + Stat√º + SKU -->
  <div class="toolbar-right d-flex align-items-center gap-2 flex-wrap">

    <!-- Ana sayfa butonu -->
    <a href="{{ url_for('index') }}" class="btn btn-secondary">‚¨Ö Ana Sayfa</a>

    <!-- Stat√º -->
    <form method="get" action="{{ url_for('dashboard') }}">
      <div class="input-group" style="max-width:160px;">
        <select class="form-select" name="status" onchange="this.form.submit()">
          {% set sel = request.args.get('status','Created') %}
          {% for s in ['Created','Picking','Invoiced','Shipped','Cancelled','Delivered','UnDelivered','Returned','UnPacked','UnSupplied'] %}
            <option value="{{s}}" {{ 'selected' if sel==s else '' }}>{{ s }}</option>
          {% endfor %}
        </select>
        <span class="input-group-text">Stat√º</span>
      </div>
    </form>

    <!-- SKU Filtre -->
<form method="get" action="{{ url_for('dashboard') }}">
  <select class="form-select" name="filter" multiple size="6" onchange="this.form.submit()"
          style="max-width:160px; min-width:140px;">
    {% set selected_filters = request.args.getlist('filter') %}
    <!-- Hepsini G√∂ster se√ßeneƒüi -->
    <option value="ALL" {% if not selected_filters or 'ALL' in selected_filters %}selected{% endif %}>
      Hepsini G√∂ster
    </option>
    {% for code in [
      "KFTK","ETK3I","BSKLE","KIKT","ETKP","TAYT","ESF3I","ESPE","SWT3I","PLZO",
      "KSKP","ESFKP","KMTK","BKTK","KKTK","OFBS","BTSH","SBP","SGP","UBP","UGP",
      "KBP","KGP","ULP","KKFE","BSKLTY","TSH","HRKA","FDKY","FSAH","KSTK","OFTA",
      "HRTK","EPA","OBSWT","DYTK","SLP","KLP","ELBS","DKP","KMNO","ESTK","SAL",
      "BAT","HRKI","CNT","MTR","PBK","OFT","PLR"
    ] %}
      <option value="{{ code }}" {% if code in selected_filters %}selected{% endif %}>
        {{ code }}
      </option>
    {% endfor %}
  </select>
</form>
  </div>
</div>

   <!-- Flash mesajlar -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Sipari≈ü tablosu -->
  <div class="table-responsive">
    <table class="table table-hover align-middle bg-white">
      <thead class="table-dark">
        <tr>
          <th>Maƒüaza</th>
          <th>Sipari≈ü / M√º≈üteri</th>
          <th>Tarih</th>
          <th>√úr√ºnler</th>
          <th>Durum</th>
          <th>ƒ∞≈ülemler</th>
          <th>Etiket Yazdƒ±r</th>
        </tr>
      </thead>
      <tbody id="ordersBody">
  {% for o in orders %}
  {% set deadline = o['extendedAgreedDeliveryDate'] or o['agreedDeliveryDate'] %}
  <tr id="order-{{ o['id'] }}" data-key="{{ o['supplier_id'] }}:{{ o['id'] }}">
    <td><span class="badge bg-info text-dark">{{ o['supplier_name'] }}</span></td>
    <td>
      <div class="fw-semibold">{{ o['orderNumber'] }}</div>
      <div class="text-muted">{{ o.get('customerFirstName','') }} {{ o.get('customerLastName','') }}</div>
    </td>
    <td>
      {% if o['giftPackageRequested'] %}
        <button type="button" class="badge text-white gift-note-btn"
                style="background:#ff8000; font-size:1.1rem; margin-bottom:5px;"
                data-note="{{ o['giftNote']|e }}"
                data-bs-toggle="modal"
                data-bs-target="#giftNoteModal">
          üéÅ Hediye Paketi
        </button><br>
      {% endif %}
      {{ o['orderDateFormatted'] }}
      <div class="small text-danger countdown" data-deadline="{{ deadline or '' }}">Kalan: ‚Äî</div>
    </td>

    <td>
      <div class="products-grid">
        {% for l in o.get('lines', []) %}
        <div class="line-card">
          <img class="product-img lazy-img"
               alt="{{ l['productName'] }}"
               loading="lazy"
               data-supplier="{{ o['supplier_id'] }}"
               data-barcode="{{ l.get('barcode','') }}"
               data-merchant-sku="{{ l.get('merchantSku','') }}"
               data-sku="{{ l.get('sku','') }}"
               data-product-code="{{ l.get('productCode','') }}">
          <div class="line-name">{{ l['productName'] }}</div>
          <div class="line-meta">Renk: {{ l.get('productColor','-') }}</div>
          <div class="line-meta">SKU: {{ l.get('merchantSku','-') }}</div>
          <div class="line-meta">Beden: {{ l.get('productSize','-') }}</div>
          <div class="line-meta">
            <span class="badge rounded-pill bg-warning text-dark qty-badge">
              Adet: {{ l.get('quantity', 1) }}
            </span>
          </div>
        </div>
        {% endfor %}
      </div>
    </td>

    <td>{{ o['status'] }}</td>

    <td style="min-width:120px;">
  <form class="d-inline" method="post" action="{{ url_for('isleme_al', supplier_id=o['supplier_id'], package_id=o['id']) }}">
    <input type="hidden" name="lines" value='{{ o.get("lines",[]) | tojson }}'>
    <input type="hidden" name="redirect_to" value="order-{{ o['id'] }}">
    <input type="hidden" name="search" value="{{ request.args.get('search','') }}">
    <input type="hidden" name="status" value="{{ request.args.get('status','Created') }}">
    <button class="btn btn-sm btn-primary">ƒ∞≈üleme Al</button>
  </form>
</td>

    <td>
      <button type="button" class="btn btn-sm btn-secondary btn-print"
              data-url="{{ url_for('etiket_yazdir', supplier_id=o['supplier_id'], package_id=o['id']) }}">
        üñ® Yazdƒ±r
      </button>
    </td>
  </tr>
  {% endfor %}
</tbody>
    </table>
  </div>

  <div id="sentinel" class="text-center">
    {% if has_more %}Daha fazla y√ºkleniyor‚Ä¶ a≈üaƒüƒ± kaydƒ±rƒ±n{% else %}Hepsi bu kadar{% endif %}
  </div>
  <!-- G√∂rsel Modal -->
  <div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen">
      <div class="modal-content"><div class="modal-body"><img id="modalImg" src="" alt="√úr√ºn"></div></div>
    </div>
  </div>

  <!-- Yazdƒ±rma Modal -->
  <div class="modal fade" id="printModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <div class="mt-2 text-muted">Etiket hazƒ±rlanƒ±yor‚Ä¶</div>
          <iframe id="printFrame" style="width:0;height:0;border:0;position:absolute;left:-9999px;"></iframe>
        </div>
      </div>
    </div>
  </div>
<script>

</script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentStatus = new URLSearchParams(location.search).get('status') || 'Created';
    let nextPage = 1;
    let hasMore = {{ 'true' if has_more else 'false' }};
    let isLoading = false;
    let orderVersion = {{ version|default(0) }};

    const tbody = document.getElementById('ordersBody');
    const sentinel = document.getElementById('sentinel');
    const searchBox = document.getElementById('searchBox');
    const todoCountEl = document.getElementById('todoCount');

   /* ==== Arama ==== */
searchBox.addEventListener('input', () => {
  const q = searchBox.value.toLowerCase().trim();
  for (const tr of tbody.querySelectorAll('tr')) {
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
  }

  // URL parametresine yaz
  const url = new URL(window.location);
  if (q) {
    url.searchParams.set('search', q);
  } else {
    url.searchParams.delete('search');
  }
  window.history.replaceState({}, '', url);
});


// Sayfa a√ßƒ±ldƒ±ƒüƒ±nda search parametresini geri y√ºkle
window.addEventListener('load', () => {
  const url = new URL(window.location);
  const q = url.searchParams.get('search') || '';
  if (q) {
    searchBox.value = q;
    const query = q.toLowerCase().trim();
    for (const tr of tbody.querySelectorAll('tr')) {
      tr.style.display = tr.innerText.toLowerCase().includes(query) ? '' : 'none';
    }
  }
});


    /* ==== G√∂rsel Modal ==== */
    const imgModalEl = document.getElementById('imgModal');
    const imgModal = bootstrap.Modal.getOrCreateInstance(imgModalEl);
    const modalImg = document.getElementById('modalImg');
    let lastOpenedSrc = '';
    document.addEventListener('click', (e) => {
      const thumb = e.target.closest('.product-img');
      if (!thumb) return;
      if (imgModalEl.classList.contains('show') && lastOpenedSrc === thumb.src) { imgModal.hide(); return; }
      lastOpenedSrc = thumb.src; modalImg.src = thumb.src; imgModal.show();
    });
    modalImg.addEventListener('click', () => imgModal.hide());

    /* ==== Yazdƒ±rma ==== */
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn-print'); if (!btn) return;
      e.preventDefault();
      const printModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('printModal'));
      const iframe = document.getElementById('printFrame');
      iframe.onload = function(){ try{ iframe.contentWindow.print(); }catch(e){} setTimeout(()=>printModal.hide(),1200); };
      iframe.src = btn.dataset.url + '?_=' + Date.now();
      printModal.show();
    });

    /* ==== Lazy Image Loader ==== */
    const imgObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;
        const img = entry.target; imgObserver.unobserve(img);
        if (img.dataset.loaded === '1') return;
        const qs = new URLSearchParams({
          supplier_id: img.dataset.supplier||'',
          barcode: img.dataset.barcode||'',
          merchantSku: img.dataset.merchantSku||'',
          sku: img.dataset.sku||'',
          productCode: img.dataset.productCode||''
        });
        fetch('/api/line-image?' + qs.toString())
          .then(r=>r.json())
          .then(d=>{ if(d&&d.url){ img.src=d.url; img.dataset.loaded='1'; } else { img.style.display='none'; }})
          .catch(()=>{ img.style.display='none'; });
      });
    }, { rootMargin:'200px 0px' });
    function observeNewImages(scope=document){ scope.querySelectorAll('img.lazy-img').forEach(img=>imgObserver.observe(img)); }

    /* ==== Countdown ==== */
    function fmt(ms){
      const s = Math.max(Math.floor(ms/1000), 0);
      const d = Math.floor(s / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      const ss = s % 60;
      if(d > 0){
        return `${d}g ${h}s ${m}d`;
      }
      return `${h}s ${m}d ${ss}sn`;
    }

    function tickCountdowns(){
      const now = Date.now();
      document.querySelectorAll('.countdown').forEach(el=>{
        const dl = Number(el.dataset.deadline || 0);
        if(!dl || isNaN(dl)){
          el.textContent = 'Kalan: ‚Äî';
          return;
        }
        const diff = dl - now;
        el.textContent = diff <= 0 ? 'Cezai ƒ∞≈ülem Yapƒ±lƒ±cak' : ('Kalan: ' + fmt(diff));
      });
    }

    /* ==== Sonsuz Kaydƒ±rma ==== */
    function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    function renderRow(o){
      const deadline = o.extendedAgreedDeliveryDate || o.agreedDeliveryDate || '';
      const productsHtml = (o.lines||[]).map(l => `
        <div class="line-card">
          <img class="product-img lazy-img" alt="${escapeHtml(l.productName)}" loading="lazy"
               data-supplier="${o.supplier_id}" data-barcode="${l.barcode||''}"
               data-merchant-sku="${l.merchantSku||''}" data-sku="${l.sku||''}" data-product-code="${l.productCode||''}">
          <div class="line-name">${escapeHtml(l.productName)}</div>
          <div class="line-meta">Renk: ${escapeHtml(l.productColor||'-')}</div>
          <div class="line-meta">Beden: ${escapeHtml(l.productSize||'-')}</div>
          <div class="line-meta"><span class="badge rounded-pill bg-warning text-dark qty-badge">Adet: ${l.quantity||1}</span></div>
        </div>`).join('');
      return `
        <tr data-key="${o.supplier_id}:${o.id}">
          <td><span class="badge bg-info text-dark">${escapeHtml(o.supplier_name)}</span></td>
          <td><div class="fw-semibold">${escapeHtml(o.orderNumber)}</div><div class="text-muted">${escapeHtml((o.customerFirstName||'')+' '+(o.customerLastName||''))}</div></td>
          <td>
  ${escapeHtml(o.orderDateFormatted)}
  ${o.giftPackageRequested ? '<div class="text-success fw-bold">üéÅ Hediye Paketi</div>' : ''}
  <div class="small text-danger countdown" data-deadline="${deadline}">Kalan: ‚Äî</div>
</td>

          <td><div class="products-grid">${productsHtml}</div></td>
          <td>${escapeHtml(o.status||'')}</td>
          <td style="min-width:120px;">
            <form class="d-inline" method="post" action="/isleme-al/${o.supplier_id}/${o.id}">
              <input type="hidden" name="lines" value='${JSON.stringify(o.lines||[])}'>
              <button class="btn btn-sm btn-primary">ƒ∞≈üleme Al</button>
            </form>
          </td>
          <td><button type="button" class="btn btn-sm btn-secondary btn-print" data-url="/etiket-yazdir/${o.supplier_id}/${o.id}">üñ® Yazdƒ±r</button></td>
        </tr>`;
    }

    const sentinelObserver = new IntersectionObserver(async (entries) => {
  if (!entries.some(e => e.isIntersecting)) return;
  if (isLoading || !hasMore) return;
  isLoading = true;
  try {
    const qs = new URLSearchParams({ status: currentStatus, page: nextPage });

   // üîπ Eƒüer URL'de birden fazla filter parametresi varsa hepsini ekle
const urlParams = new URLSearchParams(window.location.search);
urlParams.getAll('filter').forEach(f => {
  qs.append('filter', f);
});


    const res = await fetch('/api/orders?' + qs.toString());
    const data = await res.json();

    (data.orders || []).forEach(o => {
      const row = document.createElement('tbody');
      row.innerHTML = renderRow(o);
      tbody.appendChild(row.firstElementChild);
      observeNewImages(row);
    });

    hasMore = !!data.has_more;
    nextPage = (data.page || 0) + 1;
    sentinel.textContent = hasMore ? 'Daha fazla y√ºkleniyor‚Ä¶' : 'Hepsi bu kadar';
    tickCountdowns();
  } catch (e) {
    console.warn('load more failed', e);
  } finally {
    isLoading = false;
  }
}, { rootMargin: '1200px 0px' });

sentinelObserver.observe(sentinel);

    /* ==== ƒ∞lk y√ºkleme ==== */
    observeNewImages(tbody);
    tickCountdowns();
    setInterval(tickCountdowns, 1000);

    /* ==== 2 dakikada bir otomatik yenileme ==== */
    setInterval(async()=>{
      try{
        const qs=new URLSearchParams({status:currentStatus,page:0});
        const res=await fetch('/api/orders?'+qs.toString());
        const data=await res.json();
        if((data.version ?? 0)!==orderVersion){
          tbody.innerHTML='';
          (data.orders||[]).forEach(o=>{
            const row=document.createElement('tbody'); row.innerHTML=renderRow(o);
            tbody.appendChild(row.firstElementChild);
            observeNewImages(row);
          });
          orderVersion=data.version ?? orderVersion;
          nextPage=1;
          hasMore=!!data.has_more;
          sentinel.textContent=hasMore?'Daha fazla y√ºkleniyor‚Ä¶':'Hepsi bu kadar';
          tickCountdowns();
        }
      }catch(e){ console.warn('refresh failed',e); }
        }, 120000);
    // üéÅ Hediye Notu Modal kontrol√º
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.gift-note-btn');
  if (!btn) return;
  const note = btn.dataset.note || "Not yok";
  document.getElementById('giftNoteText').textContent = note;
});
  </script>

  <!-- Hediye Notu Modal -->
  <div class="modal fade" id="giftNoteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">üéÅ Hediye Notu</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <pre id="giftNoteText" class="mb-0" style="white-space: pre-wrap; font-size:0.95rem;"></pre>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
